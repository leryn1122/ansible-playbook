---
- name: NTP | Disable systemd-timesyncd
  ansible.builtin.service:
    name: systemd-timesyncd.service
    enabled: false
    state: stopped
  failed_when: false

- name: NTP | Set NTP facts
  ansible.builtin.set_fact:
    # noinspection jinja[spacing]
    ntp_service_name: >-
      {% if ntp_package == "chrony" -%}
      chronyd
      {%- elif ansible_os_family in ["RedHat", "Suse"] -%}
      ntpd
      {%- else -%}
      ntp
      {%- endif %}
    ntp_config_file: >-
      {% if ntp_package == "ntp" -%}
      /etc/ntp.conf
      {%- elif ansible_os_family in ['RedHat', 'Suse'] -%}
      /etc/chrony.conf
      {%- else -%}
      /etc/chrony/chrony.conf
      {%- endif -%}

- name: NTP | Generate NTP configuration file
  ansible.builtin.template:
    src: "etc/{{ ntp_package }}/{{ ntp_config_file | basename }}.j2"
    dest: "{{ ntp_config_file }}"
    mode: "0644"

- name: NTP | Stop NTP daeomon For Sync Immediately
  ansible.builtin.service:
    name: "{{ ntp_service_name }}"
    state: stopped
  when:
    - ntp_force_sync_immediately

- name: NTP | Immediate NTP synchronization
  # noinspection jinja[spacing]
  ansible.builtin.command: >-
    timeout -k 60s 60s
    {% if ntp_package == "chrony" -%}
    chronyd -q -f {{ ntp_config_file }}
    {%- else -%}
    ntpd -gq
    {%- endif -%}
  when:
    - ntp_force_sync_immediately

- name: NTP | Starte NTP service
  ansible.builtin.service:
    name: "{{ ntp_service_name }}"
    state: started
    enabled: true

- name: NTP | Set timezone
  community.general.timezone:
    name: "{{ ntp_timezone }}"
  when:
    - ntp_enabled
    - ntp_timezone != ""